///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

#include <ijo.h>

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

ecs_world_t *world = NULL;

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

ecs_entity_t PhaseProcessInputs = 0;
ecs_entity_t PhaseUpdate = 0;
ecs_entity_t PhaseBeginDrawing = 0;
ecs_entity_t PhaseBegin3D = 0;
ecs_entity_t PhaseDraw3D = 0;
ecs_entity_t PhaseEnd3D = 0;
ecs_entity_t PhaseBegin2D = 0;
ecs_entity_t PhaseDraw2D = 0;
ecs_entity_t PhaseDrawDebug = 0;
ecs_entity_t PhaseEnd2D = 0;
ecs_entity_t PhaseEndDrawing = 0;

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

Font main_font;

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void toggle_fullscreen (void)
{
    ToggleFullscreen ();
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void move_system (ecs_iter_t *it)
{
    float dt = it->delta_time;
    Position *p = ecs_field(it, Position, 1);
    const Velocity *v = ecs_field(it, Velocity, 2);

    for (int i = 0; i < it->count; i ++) {
        p[i].x += v[i].dx * dt;
        p[i].y += v[i].dy * dt;
    }
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void begin_drawing (ecs_iter_t *it)
{
    BeginDrawing ();
    ClearBackground ((Color) {255,255,255,255});
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void end_drawing (ecs_iter_t *it)
{
    EndDrawing ();
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void process_inputs (ecs_iter_t *it)
{
    int key = GetKeyPressed ();
    while (key)
    {
        switch (key)
        {
            case KEY_F1:
            {
                toggle_fps_counter ();
                break;
            }
            case KEY_F11:
            {
                toggle_fullscreen ();
                break;
            }

            default:
            {
                printf ("Key %d\n", key);
                break;
            }
        }
        key = GetKeyPressed ();
    }

    int ch = GetCharPressed ();
    while (ch)
    {
        printf ("Char %d\n", ch);
        ch = GetCharPressed ();
    }
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void init_phases (void)
{
    struct {
        const char *name;
        ecs_entity_t *entity;
    } phases[] = {
        { "PhaseProcessInputs", &PhaseProcessInputs, },
        { "PhaseUpdate", &PhaseUpdate, },
        { "PhaseBeginDrawing", &PhaseBeginDrawing, },
        { "PhaseBegin3D", &PhaseBegin3D, },
        { "PhaseDraw3D", &PhaseDraw3D, },
        { "PhaseEnd3D", &PhaseEnd3D, },
        { "PhaseBegin2D", &PhaseBegin2D, },
        { "PhaseDraw2D", &PhaseDraw2D, },
        { "PhaseEnd2D", &PhaseEnd2D, },
        { "PhaseDrawDebug", &PhaseDrawDebug, },
        { "PhaseEndDrawing", &PhaseEndDrawing, },
    };

    ecs_entity_t last_phase = 0;

    for (int i = 0; i < sizeof (phases) / sizeof (phases[0]); i ++)
    {
        ecs_entity_t phase = ecs_new_w_id (world, EcsPhase);
        ecs_set_name (world, phase, phases[i].name);
        *phases[i].entity = phase;

        if (last_phase)
        {
            ecs_add_pair (world, phase, EcsDependsOn, last_phase);
        }
        else
        {
            ecs_add_pair (world, phase, EcsDependsOn, EcsOnUpdate);
        }
        last_phase = phase;
    }
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void init_world (void)
{
    world = ecs_init ();

    ecs_singleton_set (world, EcsRest, {0});
    ECS_IMPORT (world, FlecsMonitor);

    init_phases ();
    init_components ();

    ECS_SYSTEM (world, begin_drawing, PhaseBeginDrawing, );
    ECS_SYSTEM (world, end_drawing, PhaseEndDrawing, );
    ECS_SYSTEM (world, process_inputs, PhaseProcessInputs, );

    init_fps_counter ();
    init_trees ();

    mk_tree (30, 50);
    mk_tree (90, 30);
    mk_tree (140, 60);
    mk_tree (190, 40);

    ECS_SYSTEM (world, move_system, PhaseUpdate, Position, Velocity);
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void create_default_state (void)
{
    ecs_entity_t e = ecs_new_id (world);

    ecs_set (world, e, Position, {1, 2});
    ecs_set (world, e, Velocity, {3, 4});
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void deinit_world (void)
{
    ecs_fini (world);
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

int main (int argc, char **argv)
{
    SetTraceLogLevel (LOG_WARNING);
    SetConfigFlags (FLAG_MSAA_4X_HINT);
    InitWindow (1280, 720, "ijo");
    SetWindowState (
        FLAG_WINDOW_RESIZABLE |
        FLAG_VSYNC_HINT |
        0);

    main_font = LoadFontFromMemory (".otf", atkinson_regular, atkinson_regular_len, 30, NULL, 0);

    init_world ();

    create_default_state ();

    while (!WindowShouldClose ())
    {
        if (IsWindowFocused ())
        {
            SetWindowState (FLAG_VSYNC_HINT);
            SetTargetFPS (0);
        }
        else
        {
            ClearWindowState (FLAG_VSYNC_HINT);
            SetTargetFPS (30);
        }

        ecs_progress (world, 0);
    }

    deinit_world ();
    CloseWindow ();

    return 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
