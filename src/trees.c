///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

#include "ijo.h"

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

const float growth_rate = 0.1;

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void update_trees_system (ecs_iter_t *it)
{
    float dt = it->delta_system_time;
    Tree *t = ecs_field(it, Tree, 1);

    for (int i = 0; i < it->count; i ++) {
        t[i].growth += growth_rate * dt;
        if (t[i].growth > 1)
        {
            t[i].growth = 1;
        }
    }
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void draw_trees_system (ecs_iter_t *it)
{
    const Position *p = ecs_field(it, Position, 1);
    const Tree *t = ecs_field(it, Tree, 2);

    for (int i = 0; i < it->count; i ++) {
        float x = p[i].x;
        float y = p[i].y;
        float g = t[i].growth;

        DrawCircleLines (x, y, g * 30, BLACK);
        DrawCircleV ((Vector2){x, y}, g * 30, (Color){0, 255, 0, 255});
    }
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

ecs_entity_t mk_tree (float x, float y)
{
    ecs_entity_t e = ecs_new_id (world);
    ecs_set (world, e, Tree, {.growth = 0.1});
    ecs_set (world, e, Position, {.x = x, .y = y});
    return e;
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void init_trees (void)
{
    ECS_COMPONENT_DEFINE (world, Tree);

    ecs_system (world, {
        .entity = ecs_entity (world, {
            .name = "update_trees_system",
            .add = { ecs_dependson (PhaseUpdate) },
        }),
        .query.filter.terms = {
            { ecs_id (Tree) },
        },
        .interval = 1.0,
        .callback = update_trees_system,
    });

    ECS_SYSTEM (world, draw_trees_system, PhaseDraw2D, Position, Tree);
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
