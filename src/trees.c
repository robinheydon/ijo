///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

#include "ijo.h"

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

typedef struct Tree
{
    float growth;
} Tree;

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void update_trees_system (ecs_iter_t *it)
{
    float dt = it->delta_system_time;
    Tree *t = ecs_field(it, Tree, 1);

    for (int i = 0; i < it->count; i ++) {
        t[i].growth += dt;
        if (t[i].growth > 1)
        {
            t[i].growth = 1;
        }

        printf ("%lu %f\n", it->entities[i], t[i].growth);
    }
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

ecs_entity_t mk_tree (float x, float y)
{
    ecs_entity_t e = ecs_new_id (world);
    ecs_set (world, e, Tree, {.growth = 0.1});
    ecs_set (world, e, Position, {.x = x, .y = y});
    return e;
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void init_trees (void)
{
    ECS_COMPONENT_DEFINE (world, Tree);

    ecs_system (world, {
        .entity = ecs_entity (world, {
            .name = "update_trees_system",
            .add = { ecs_dependson (PhaseUpdate) },
        }),
        .query.filter.terms = {
            { ecs_id (Tree) },
        },
        .interval = 10.0,
        .callback = update_trees_system,
    });
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
